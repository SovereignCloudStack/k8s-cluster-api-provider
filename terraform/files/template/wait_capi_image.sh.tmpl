#!/usr/bin/env bash

KUBERNETES_VERSION="${kubernetes_version}"
PROVIDER="${provider}"
UBU_IMG_NM=ubuntu-capi-image-$KUBERNETES_VERSION

#download/upload image to openstack
echo -n "Waiting for image $CAPIIMG to become active: "
let -i ctr=0
while test $ctr -lt 180; do
  CAPIIMG=$(openstack --os-cloud $PROVIDER image list --name $UBU_IMG_NM -f value -c ID -c Status)
  if test -z "$CAPIIMG"; then
    echo; echo "ERROR: Image $UBU_IMG_NM does not exist" 1>&2; exit 1
  fi
  if test "$${CAPIIMG##* }" = "active"; then echo "$CAPIIMG"; break; fi
  echo -n "."
  let ctr+=1
  sleep 10
done
if test $ctr -ge 180; then echo "TIMEOUT"; exit 2; fi

